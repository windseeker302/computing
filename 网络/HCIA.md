# 一、网络参考模型

在学习本学习文档时，请自学IP地址基于IP规划等理论知识；

常用的参考模型有两种，OSI七层模型和TCP/IP五层模型，TCP/IP 业界被广泛使用，但学习OSI七层也必不可少。
## 1.1 OSI七层模型

| 7.应用层   | 对应用程序提供接口。                                    |
| ------- | --------------------------------------------- |
| 6.表示层   | 进行数据格式的转换，以确保一个系统生成的应用层数据能够被另外一个系统的应用层所识别和理解。 |
| 5.会话层   | 在通信双方之间建立，管理和终止会话。                            |
| 4.传输层   | 建立、维护和取消一次端到端的数据传输过程。控制传输节奏的快慢，调整数据的排序等等。     |
| 3.网络层   | 定义逻辑地址;实现数据从源到目的地的转发。                         |
| 2.数据链路层 | 将分组数据封装成帧;在数据链路上实现数据的点到点、或点到多点方式的直接通信;差错检测。   |
| 1.物理层   | 在媒介上传输比特流;提供机械的和电气的规约。                        |

## 1.2 TCP/IP五层模型

因为0SI协议栈比较复杂，且TCP和IP两大协议在业界被广泛使用，所以TCP/IP参考模型成为了互联网的主流参考模型。

![[Pasted image 20250804235637.png]]


- 常见 TCP/IP 协议

TCP/IP协议栈定义了一系列的标准协议

![[Pasted image 20250804235725.png]]


### 1) 应用层

- 应用层为应用软件提供接口，使应用程序能够使用网络服务。应用层协议会指定使用相应的传输层协议，以及传输层所使用的端口等。
- 应用层的PDU被称为Data(数据)。

![[Pasted image 20250805000100.png]]

### 2) 传输层

- 传输层协议接收来自应用层协议的数据，封装上相应的传输层头部，帮助其建立立“端到端（Port to Port）的连接。
- 传输层的PDU被称为Segment(段)。

![[Pasted image 20250805000241.png]]

- 报文格式

![[Pasted image 20250805000342.png]]

- TCP 的建立-三次握手
	- TCP使用序列号和确认序列号字段实现数据的可靠和有序传输。
	- 任何基于TCP的应用，在发送数据之前，都需要由TCP进行“三次握手”建立连接。

![[Pasted image 20250805000547.png]]

- TCP 的建立-四次挥手
	- 当数据传输完成，TCP需要通过“四次挥手”机制断开TCP连接，释放系统资源。

![[Pasted image 20250805000729.png]]

### 3) 网络层

- 传输层负责建立主机之间进程与进程之间的连接，而网络层则负责数据从一台主机到另外一台主机之间的传递。
- 网络层的PDU被称为Packet（包）

![[Pasted image 20250805000820.png]]

### 4) 数据链路层

- 数据链路层位于网络层和物理层之间，可以向网络层的IP、IPv6等协议提供服务。数据链路层的PDU被称为Frame（帧）。
- 以太网（Ethernet）是最常见的数据链路层协议。


![[Pasted image 20250805000857.png]]

- 以太网和MAC地址
	- 以太网定义
		- 以太网是一种广播式数据链路层协议，支持多点接入个人电脑的网络接口遵循的就是以太网标准；一般情况下，一个广播域对应着一个IP网段。
	- MAC地址
		- MAC(Media Access Control)地址在网络中唯一标识一个网卡，每个网卡都需要且会有唯一的一个MAC地址
		- MAC用于在一个IP网段内，寻址找到具体的物理设备
		- 工作在数据链路层的设备例如以太网交换机，会维护一张MAC地址表，用于指导数据帧转发。

### 5) 物理层

- 数据到达物理层之后，物理层会根据物理介质的不同，将数字信号转换成光信号、电信号或者是电磁波信号。
- 物理层的PDU被称为比特流(Bitstream)


![[Pasted image 20250805001310.png]]

## 1.3 常见协议标准化组织

- ISO(International Organization for Standardization)
	在制定计算机网络标准方面，ISO是起着重大作用的国际组织，如OSI模型，定义于ISO/IEC7498-1。
- IETF(lnternet Engineering Task Force)
	负责开发和推广互联网协议（特别是构成TCP/IP协议族的协议）的志愿组织，通过RFC发布新的或者取代老的协议标准。
- IEEE(lnstitute of Electrical and Electronics Engineers)
	IEEE制定了全世界电子、电气和计算机科学领域30%左右的标准，比较知名的有IEEE802.3(Ethernet)、IEEE802.11(Wi-Fi)等。

# 二、下载和安装ensp

[文档链接直达](https://bbs.huaweicloud.com/blogs/422935)

启动 AR 时，报错问题 40

解决问题：[折磨了我5个小时，eNSP启动路由器出现40,41报错完美解决。（几乎踩过所有的坑）亲测：文章的每一步我都试过_ensp错误代码40-CSDN博客](https://blog.csdn.net/weixin_66202187/article/details/144956100)

# 三、地址解析协议（ARP）

ARP(Address Resolution Protocol)地址解析协议：根据已知的IP地址解析获得其对应的MAC地址。

![[Pasted image 20250805163100.png]]

### 3.1 工作流程：

假设主机A和B在同一个网段，主机A要向主机B发送信息，具体的地址解析过程如下：

- (1) 主机A首先查看自己的ARP表，确定其中是否包含有主机B对应的ARP表项。如果找到了对应的MAC地址，则主机A直接利用ARP表中的MAC地址，对IP数据包进行帧封装，并将数据包发送给主机B。
- (2) 如果主机A在ARP表中找不到对应的MAC地址，则将缓存该数据报文，然后以广播方式发送一个ARP请求报文。
- ARP请求报文中的发送端IP地址和发送端MAC地址为主机A的IP地址和MAC地址，目标IP地址和目标MAC地址为主机B的IP地址和全0的MAC地址。
- 由于ARP请求报文以广播方式发送，该网段上的所有主机都可以接收到该请求，但只有被请求的主机（即主机B）会对该请求进行处理。
- (3) 主机B比较自己IP地址和ARP请求报文中的 目标IP 地址，当两者相同时进行如下处理：将ARP请求报文中的发送端（即主机A）的IP地址和MAC地址存入自己的ARP表中。
- 之后以单播方式发送ARP响应报文给主机A，其中包含了自己的MAC地址。
- (4) 主机A收到ARP响应报文后，将主机B的MAC地址加入到自己的ARP表中以用于后续报文的转发，同时将IP数据包进行封装后发送出去。

![[Pasted image 20250805153317.png]]

### 3.2 实验：

在eNSP上创建一个交换机，两个客户端电脑，并给这两个电脑配置上ip地址，开始实验。

![[Pasted image 20250805222402.png]]
### 3.3 抓包分析：

![[Pasted image 20250805153546.png]]

### 3.4 ARP请求报文:

![[Pasted image 20250805154626.png]]
 
### 3.5 ARP响应报文:

![[Pasted image 20250805163216.png]]

### 3.6 动态学习与缓存机制：

- **ARP缓存：** 为了提高效率和减少网络广播，每台主机或网络设备都会维护一个ARP缓存（ARP表）。 这个缓存用于存储近期学习到的IP地址与MAC地址的映射关系。
- **工作流程：** 当需要发送数据时，设备会首先检查自己的ARP缓存。如果缓存中存在目标IP地址对应的MAC地址，则直接使用该地址，无需再次发起ARP请求。 如果缓存中没有，设备会广播一个ARP请求。 局域网内拥有该IP地址的设备会以单播的方式回应一个ARP应答，告知自己的MAC地址。 请求方收到应答后，会将这个新的映射关系存入ARP缓存中以备后用。
- **老化机制：** ARP缓存中的条目不是永久有效的，它们有一个生存时间（TTL），典型值为20分钟。 超过设定的时间后，动态学习到的ARP条目会自动老化并被删除，以确保缓存中的信息是相对较新的。 Linux等操作系统有具体的垃圾回收（GC）机制来管理老化过程。

### 3.7 广播请求与单播应答

ARP协议的工作方式具有明确的请求和响应模式。

- **广播请求：** 当需要解析一个IP地址时，设备会向整个局域网发送一个ARP请求广播包。这个包的目的MAC地址是特殊的广播地址（FF-FF-FF-FF-FF-FF），确保网络内所有设备都能收到。
- **单播应答：** 只有拥有该请求IP地址的设备才会响应该请求，并向请求方发送一个ARP应答包。这个应答包是单播的，直接发送给请求方的MAC地址，避免了对网络中其他设备的打扰。



# 四、VRP

**Versatile Routing Platform（通用路由平台）是华为公司数据通信产品的通用操作系统平台作为华为公司从低端到核心的全系列路由器、以太网交换机、业务网关等产品的软件核心引擎。

VRP提供了一整套功能和协议，用于管理和配置网络设备，实现数据转发、路由选择、安全控制等。
### 4.1 VRP 的发展

![[Pasted image 20250805164129.png]]

### 4.2 文件系统

文件系统是指对存储器中文件、目录的管理，功能包括查看、创建、重命名和删除目录，拷贝、移动、重命名和删除文件等。和常用 linux 文件系统是一样的。

存储设备包括：SDRAM、Flash、NVRAM、SD Card、USB。

### 4.3 设备初始化过程

设备上电后，首先运行BootROM软件，初始化硬件并显示设备的硬件参数，然后运行系统软件，最后从默认存储路径中读取配置文件进行设备的初始化操作。

### 4.4 设备管理

用户对设备的常见管理方式主要有命令行方式和Web网管方式两种
用户需要通过相应的方式登录到设备后才能对设备进行管理
- Web 网管方式
- 命令行方式

### 4.5. VRP用户级别

VRP提供基本的权限控制，可以实现不同级别的用户能够执行不同级别的命令，用以限制不同用户对设备的操作。

| 用户等级 | 命名等级        | 名称  | 说明                                                                          |
| ---- | ----------- | --- | --------------------------------------------------------------------------- |
| 0    | 0           | 参观级 | 可使用网络诊断工具命令（ping、tracert）、从本设备出发访问外部设备的命令（Telnet客户端命令）、部分display命令等         |
| 1    | 0 and 1     | 监控级 | 用于系统维护，可使用display等命令。                                                       |
| 2    | 0，1 and 2   | 配置级 | 可使用业务配置命令，包括路由、各个网络层次的命令，向用户提供直接网络服务。                                       |
| 3-15 | 0，1，2 and 3 | 管理级 | 可使用用于系统基本运行的命令，对业务提供支撑作用，包括文件系统、FTP、TFTP下载、命令级别设置命令以及用于业务故障诊断的debugging命令等。 |

命令行方式 - 本地登录

设备登录方式分为两种：本地登录和远程登录。其中本地登录包括：
- 当用户需为第一次上电的设备进行配置时可通过console口本地登录设备。
- 控制口 (Console Port)是一种通信串行端口，由设备的主控板提供。
- 用户终端的串行端口可以与设备console口直接连接，然后通过PuTTY工具本地登录实现对设备的本地配置。
本地登录时，终端设备采用串口与华为设备Console口连接，所以采用"Serial"连接类型COM端口根据终端设备实际端口选取，速率固定为9600。

### 4.6 命令配置

华为提供的命令按照一定的格式设计，用户可以通过命令行界面输入命令，由命令行界面对命令
进行解析，实现用户对路由器的配置和管理。

![[Pasted image 20250805165636.png]]

- 命令字：规定了系统应该执行的功能，如display（查询设备状态），reboot（重启设备）等命令字。
- 关键字：特殊的字符构成，用于进一步约束命令，是对命令的拓展，也可用于表达命令构成逻辑而增设的补充字符串。
- 参数列表：是对命令执行功能的进一步约束。包括一对或多对参数名和参数值。

### 4.7 命令行视图

设备提供了多样的配置和查询命令，为便于用户使用这些命令，VRP系统按功能分类将命令分别注册在不同的命令行视图下

![[Pasted image 20250805165908.png]]

- 用户视图：用户可以完成查看运行状态和统计信息等功能。
	- 视图提示符： \<Huawei\>
- 系统视图：用户可以配置系统参数以及通过该视图进入其他的功能配置视图。
	- 视图提示符： \[Huawei\]
- 其他视图：比如接口视图，协议视图，用户可以进行接口参数和协议参数配置。
	- 接口视图提示符： \[Huawei-GigabitEthernet0/0/1\]
	- 协议视图提示符： \[Huawei-ospf-1\]

### 4.8 使用命令行在线帮助

用户在使用命令行时，可以使用在线帮助以获取实时帮助，从而无需记忆大量的复杂的命令。

命令行在线帮助可分为完全帮助和部分帮助，可通过输入“？”实现。

### 4.9 解读命令行的错误信息

用户键入的命令，如果通过语法检查，则正确执行，否则系统将会向用户报告错误信息。

~~~shell
[Huawei]name?
        ^
	Error: Unrecognized command found at '^' position.    # 箭头所指地方提示该命令不能识别，需要确认命令正确性

[Huawei]sysname
                ^
Error:Incomplete command found at '^' position.    # 箭头所指地方提示命令不完整，需要进一步补齐

[Huawei]a
        ^
Error:Ambiguous command found at '^' position.    # 箭头所指的命令不明确，不有多个a开头的命令字


~~~

### 4.10 使用undo命令行

在命令前加undo关键字，即为undo命令行。undo命令行一般用来恢复缺省情况、禁用某个功能或
者删除某项配置。以下为参考案例：

~~~shell
[Huawei]ftp server enable 
Info: Succeeded in starting the FTP server.
[Huawei]
Aug  5 2025 17:12:48-08:00 Huawei DS/4/DATASYNC_CFGCHANGE:OID 1.3.6.1.4.1.2011.5
.25.191.3.1 configurations have been changed. The current change number is 4, th
e change loop count is 0, and the maximum number of records is 4095.
# 使用undo命令禁用某个功能
[Huawei]undo ftp server
Warning: The operation will stop the FTP server. Continue? [Y/N]:y
Info: Succeeded in closing the FTP server.
~~~


### 4.11 基本配置命令

- 配置设备名称
	~~~shell
	[Huawei]sysname S1
	~~~
- 配置系统时钟
	~~~shell
	<S1>clock timezone zone1 {add | minus} offset
	~~~
- 配置命令等级
	~~~shell
	[S1]command-privilege level 3 view system sysname
	[S1]command-privilege level <级别> view <视图名字> <命令>
	~~~
	用来设置指定视图内的命令的级别，命令级别分为参观、监控、配置、管理4个级别，分别对应标识0、1、2、3。
- 配置用户通过Password登录设备
	~~~shell
	[S1]user-interface vty 0 4
	[S1-ui-vty0-4]set authentication password cipher Qwer_12#$
	~~~
	用来进入指定的用户视图并配置用户认证方式为password。系统支持的用户界面包括console用户界面和vTy用户界面，
	Console界面用于本地登录，VTY界面用于远程登录。默认情况下，设备一般最多支持15个用户同时通过vTY方式访问。
- 配置用户连接的超时时间
	~~~shell
	[S1-ui-vty0-4]idle-timeout 35791 59
	~~~
	用来设置用户界面断开连接的超时时间系统将断开连接。缺省情况下，超时时间是10分钟。
 - 配置接口 ip 地址
	~~~shell
	[S1]interface Ethernet 0/0/1
	[S1-Ethernet0/0/1]ip address ip address
	~~~
- 关于保存配置
	~~~shell
	# 查看当前运行的配置文件
	<Huawei>display current-configuration 
	# 配置文件保存
	<Huawei>save
	# 查看保存的配置
	<Huawei>display saved-configuration 
	# 查看系统启动配置参数
	<Huawei>display startup
	# 清除已保存的配置
	<Huawei>reset saved-configuration 
	# 配置系统下次启动时使用的配置文件
	<Huawei>startup saved-configuration config
	~~~
- 设备重启
	~~~shell
	<Huawei>reboot
	~~~
- 查看路由表
	~~~shell
	[Huawei]display ip routing-table
	~~~
- 查看接口信息
	~~~shell
	[Huawei]display ip interface [brief]
	~~~
- 查看接口进入接口并配置IP
    ~~~shell
	[Huawei]display ip interface brief 
	*down: administratively down
	^down: standby
	(l): loopback
	(s): spoofing
	The number of interface that is UP in Physical is 3
	The number of interface that is DOWN in Physical is 1
	The number of interface that is UP in Protocol is 1
	The number of interface that is DOWN in Protocol is 3
	
	Interface                         IP Address/Mask      Physical   Protocol  
	GigabitEthernet0/0/0              unassigned           up         down      
	GigabitEthernet0/0/1              unassigned           up         down      
	GigabitEthernet0/0/2              unassigned           down       down      
	NULL0                             unassigned           up         up(s)     
	[Huawei]interface GigabitEthernet 0/0/0
	[Huawei-GigabitEthernet0/0/0]ip address 10.0.0.254 24
	~~~
# 五、网络层详解

网络层经常被称为IP层。但网络层协议并不只是IP协议，还包括ICMP（Internet Control MessageProtocol)协议、IPX （Internet Packet Exchange）协议等。

![[Pasted image 20250805211443.png]]

- ICMP 常用命令：
	- ping
	- tracert
## 5.1 网络层协议

IPv4 (InternetProtocolVersion 4)协议族是TCP/IP协议族中最为核心的协议族。它工作在TCP/IP协议栈的网络层，该层与OSI参考模型的网络层相对应。
网络层提供了无连接数据传输服务，即网络在发送数据报文时不需要先建立连接，每一个IP数据报文独立发送。

### 1) ip协议

IP是Internet Protocol的缩写。InternetProtocol本身是一个协议文件的名称，该协议文件的内容非
常少，主要是定义并阐述了IP报文的格式。
经常被提及的IP，一般不是特指Internet Protocol这个协议文件本身，而是泛指直接或间接与IP协议
相关的任何内容。

![[Pasted image 20250805211809.png]]

> 更多
> IPv4 地址 4B（字节/Byte）,32bit（位）。
> IPv4 地址 8B（字节/Byte）,128bit（位）。


## 5.2 数据封装

数据封装（Data Encapsulation）是指应用程序产生的数据，在网络中自上而下通过协议栈的每一层时，都会被添加上该层的控制信息（称为 **“头部 Header”** ，有时在数据链路层还有“尾部 Trailer”）的过程。这个添加了头部（和尾部）的数据单元，在每一层都有一个特定的名字，称为**协议数据单元（PDU）**。

![[Pasted image 20250805212213.png]]

### 1) IPv4 报文格式：

![[Pasted image 20250805212604.png]]

### 2) 字段详解：
#### 第1行

1. **版本 (Version) - 4位**
    
    - **作用**: 定义IP协议的版本。
    - **值**: 对于IPv4，这个值永远是 **`4`**（二进制 `0100`）。对于IPv6，值是 `6`。这个字段是报文处理的第一步，路由器看到版本号为4，就知道要按IPv4的规则来处理。
2. **首部长度 (IHL: Internet Header Length) - 4位**
    
    - **作用**: 表示整个IP头部的长度。
    - **单位**: 它的单位是 **“4字节”**（32位字）。
    - **值**:
        - 最小值是 **`5`**（二进制 `0101`），表示 5 * 4 = **20字节**。这是最常见的情况，代表一个不包含任何“选项”字段的标准IP头部。
        - 最大值是 **`15`**（二进制 `1111`），表示 15 * 4 = **60字节**。
3. **服务类型 (ToS: Type of Service) - 8位**
    
    - **作用**: 用于实现服务质量（QoS）。它告诉网络设备这个报文的优先级，比如是普通数据还是语音通话数据（需要低延迟）。
    - **现在**: 这个字段已被重新定义为**差分服务 (Differentiated Services, DS)**，其中前6位是**DSCP**（差分服务代码点），后2位是**ECN**（显式拥塞通知）。
4. **总长度 (Total Length) - 16位**
    
    - **作用**: 表示整个IP报文的长度，**包括头部和数据载荷**。
    - **单位**: 字节。
    - **值**: 最大值是 2^16 - 1 = 65535字节。但由于以太网的MTU（最大传输单元）限制，通常一个IP包远小于这个值（约1500字节）。

#### 第2行 (与分片相关)

当一个IP包的大小超过了下一跳网络的MTU时，路由器就需要将其**分片 (Fragmentation)**。以下三个字段协同工作来处理分片和重组。

5. **标识 (Identification) - 16位**
    
    - **作用**: 唯一标识一个原始IP包。当一个包被分片后，**所有分片都拥有相同的标识号**。这告诉目的主机：“这些小碎片都属于同一个原始大包裹”。
6. **标志 (Flags) - 3位**
    
    - **作用**: 控制分片行为。
    - **第0位**: **保留位**，必须为`0`。
    - **第1位**: **DF (Don't Fragment)**。`1`表示“禁止分片”。如果路由器需要分片但看到此位为1，它会丢弃该包并向源主机发送一个ICMP错误消息。
    - **第2位**: **MF (More Fragments)**。`1`表示“后面还有分片”。除了最后一个分片，其他所有分片此位都为`1`。最后一个分片此位为`0`，表示这是最后一个碎片。
7. **片偏移 (Fragment Offset) - 13位**
    
    - **作用**: 指明当前分片的数据部分在原始数据中的起始位置。
    - **单位**: **“8字节”**。
    - **值**: 第一个分片的偏移量为0。如果一个分片的数据部分有1480字节，那么下一个分片的偏移量就是 1480 / 8 = 185。目的主机根据这个偏移量来像拼图一样将所有分片按正确顺序重组。

#### 第3行

8. **生存时间 (TTL: Time To Live) - 8位**
    
    - **作用**: 防止数据包在网络中无限循环。
    - **工作原理**: 源主机设置一个初始值（如64或128）。每经过一个路由器，该值就**减1**。当TTL减到`0`时，路由器会丢弃该包，并向源主机发送一个ICMP“超时”消息。`traceroute`命令就是利用这个原理来探测路径的。
9. **协议 (Protocol) - 8位**
    
    - **作用**: 指明IP报文的数据载荷部分封装的是**哪种上层协议**的数据。
    - **常见值**:
        - **`6`**: TCP协议
        - **`17`**: UDP协议
        - **`1`**: ICMP协议
    - 目的主机的IP层根据这个值，决定将数据交给哪个上层协议处理。
10. **首部检验和 (Header Checksum) - 16位**
    
    - **作用**: **仅用于校验IP头部的完整性**，不校验数据载荷。
    - **工作原理**: 发送方计算头部校验和并填充此字段。每个路由器在转发前都会重新计算一遍。由于TTL在每一跳都会改变，所以**校验和在每一跳也必须重新计算**。如果校验失败，路由器会丢弃该包。

#### 第4行

11. **源IP地址 (Source IP Address) - 32位**
    - **作用**: 发送方设备的IP地址。

#### 第5行

12. **目的IP地址 (Destination IP Address) - 32位**
    - **作用**: 接收方设备的IP地址。

#### 可选部分

13. **选项 (Options) - 可变长度**
    - **作用**: 提供一些额外的功能，如记录路由（记录数据包经过的路由器IP）、时间戳、严格/松散源路由等。
    - **注意**: 由于选项字段会增加头部处理的复杂性并影响性能，现在已很少使用。如果使用了选项字段，其长度必须是4字节的倍数，不足部分由**填充 (Padding)**字段补`0`凑齐。


## 4.3 IPv4 地址

**IPv4地址**（Internet Protocol version 4 Address）是互联网协议第四版的地址，它是互联网上设备（如电脑、手机、服务器、路由器等）的**唯一数字标识**。

您可以把它想象成**互联网世界的“门牌号”或“电话号码”**。当你的电脑想访问一个网站（比如谷歌的服务器）时，它必须知道对方的IP地址，才能准确地将数据发送过去，并让对方知道要把数据回传给谁。

### 1) IPv4地址的样子

我们最常见到的IPv4地址形式是 **点分十进制（Dotted-Decimal Notation）** 格式，像这样：

`192.168.1.1`  
`8.8.8.8`

它由**四个**被点（`.`）分隔的数字组成，每个数字的取值范围是 **0 到 255**。

### 2) IPv4地址的本质：32位二进制数

虽然我们看到的是十进制数字，但在计算机内部，一个IPv4地址实际上是一个**32位的二进制数**。

- **32位**：意味着它由32个0或1组成。
- **4个八位组（Octet）**：为了方便人类阅读，这32位被分成了4段，每段8位（称为一个八位组或字节）。


### 3) 特殊地址

IP地址空间中，有一些特殊的IP地址，这些IP地址有特殊的含义和作用，举例如下。

| 特殊IP地址 | 地址范围            | 作用                                 |
| ------ | --------------- | ---------------------------------- |
| 有限广播地址 | 255.255.255.255 | 可作为目的地址，发往该网段所有主机(受限于网关)           |
| 任意地址   | 0.0.0.0         | “任何网络”的网络地址;<br>“这个网络上这个主机接口”的IP地址 |
| 回环地址   | 127.0.0.0/8     | 测试设备自身的软件系统                        |
| 本地链路地址 | 169.254.0.0/24  | 当主机自动获取地址失败后，可使用该网段中的某个地址进行临时通信    |

### 4) IPv4 vs IPv6

由全球IP地址分配机构，IANA(Internet Assigned Numbers Authority)管理的IPv4地址，于2011年完
全用尽。随着最后一个IPv4公网地址分配完毕，加上接入公网的用户及设备越来越多，IPv4地址枯
竭的问题日益严重，这是当前IPv6替代IPv4的最大源动力。

### 5) 私有地址

标准的私有地址范围

互联网工程任务组（IETF）规定了以下三个地址段作为私有地址，任何人都可以自由使用：

| 类别     | 地址范围                              | 对应的CIDR表示        | 规模说明               | 常见场景           |
| ------ | --------------------------------- | ---------------- | ------------------ | -------------- |
| **A类** | `10.0.0.0` 到 `10.255.255.255`     | `10.0.0.0/8`     | 可容纳约1600万个主机，非常巨大  | 大型企业、数据中心      |
| **B类** | `172.16.0.0` 到 `172.31.255.255`   | `172.16.0.0/12`  | 可容纳约100万个主机，范围较灵活  | 中到大型企业、校园网     |
| **C类** | `192.168.0.0` 到 `192.168.255.255` | `192.168.0.0/16` | 每个子网可容纳254个主机，规模较小 | **家庭网络**、小型办公室 |

如果你在电脑上查看自己的IP地址，发现是以上范围内的任意一个，那么你使用的就是私有地址。

私有地址 vs 公有地址

|特性|**私有地址 (Private IP)**|**公有地址 (Public IP)**|
|---|---|---|
|**唯一性**|在局域网内唯一，全球可重复|**全球唯一**|
|**范围**|局域网（LAN）内部|整个互联网（WAN）|
|**获取方式**|免费，由路由器等设备自动分配|由运营商（ISP）分配，通常需付费|
|**互联网访问**|**间接访问**（通过NAT转换）|**直接访问**|
|**比喻**|内部身份证、公司分机号|全球护照、公司总机号码|

# 六、IP路由基础

## 6.1 概念

- 在一个典型的数据通信网络中，往往存在多个不同的IP网段，数据在不同的IP网段之间交互是需要借助三层设备的，这些设备具备路由能力，能够实现数据的跨网段转发。

- 路由是数据通信网络中最基本的要素。路由信息是指导报文转发的路径信息，路由过程就是报文转发的过程。

## 6.2 路由

- 路由是指导报文转发的路径信息，通过路由可以确认转发IP报文的路径。
- 路由设备是依据路由转发报文到目的网段的网络设备，最常见的路由设备：路由器。
- 路由设备维护着一张路由表，保存着路由信息。
![[Pasted image 20250805221940.png]]

## 6.3 路由信息介绍

- 路由中包含以下信息：
	- 目的网络：标识目的网段。
	- 掩码：与目的地址共同标识一个网段。
	- 出接口：娄数据包被路由后离开本路由器的接口。
	- 下一跳：路由器转发到达目的网段的数据包所使用的下一跳地址。
- 这些信息标识了目的网段、明确了转发IP报文的路径。

![[Pasted image 20250805222016.png]]

## 6.4 路由表

![[Pasted image 20250805224456.png]]

- 路由器通过各种方式发现路由
- 路由器选择最优的路由条目放入路由表中
- 路由表指导设备对IP报文的转发
- 路由器通过对路由表的管理实现对路径信息的管理

## 6.5 路由信息获取方式

路由器依据路由表进行路由转发，为实现路由转发，路由器需要发现路由，以下为常见的路由获方式。

直连路由：由设备自动生成指向本地直连网络
静态路由：由网络管理员手工配置的路由条目
动态路由：路由器运行动态路由协议学习到的路由

~~~shell
[AR1-GigabitEthernet0/0/1]display ip routing-table 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 7        Routes : 7        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       10.0.0.0/24  Direct  0    0           D   10.0.0.254      GigabitEthernet
0/0/1
     10.0.0.254/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/1
     10.0.0.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/1
      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0
      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0
127.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0
255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0
~~~
路由表信息解析
- Destination/Mask：目的网络地址/网络掩码长度
- Proto：协议类型
- pre：路由优先级
- Cost：开销 (度量值）
- Flags：标志
- NextHop：下一跳地址
- Interface：出接口

## 6.6 直连路由

![[Pasted image 20250805224923.png]]

- 直连路由指向本地直连网络的路由，由设备自动生成。
- 当路由器为路由转发的最后一跳路由器时，IP报文匹配直连路由，路由器转发IP报文到目的主机
- 使用直连路由进行路由转发时，报文的目的IP和路由器接口IP在一个网段之中

路由条目生成实验：

- 并不是所有接口生成的直连路由都会出现在路由表中，直连路由出现在路由表中的前提是该接口的物理状态、协议状态都为UP。

![[Pasted image 20250806002246.png]]


~~~shell
[AR1]interface g0/0/1
[AR1-GigabitEthernet0/0/1]ip address 10.0.0.254 24
[AR1-GigabitEthernet0/0/1]display ip interface brief 
*down: administratively down
^down: standby
(l): loopback
(s): spoofing
The number of interface that is UP in Physical is 2
The number of interface that is DOWN in Physical is 2
The number of interface that is UP in Protocol is 2
The number of interface that is DOWN in Protocol is 2

Interface                         IP Address/Mask      Physical   Protocol  
GigabitEthernet0/0/0              unassigned           down       down      
GigabitEthernet0/0/1              10.0.0.254/24        up         up        
GigabitEthernet0/0/2              unassigned           down       down      
NULL0                             unassigned           up         up(s)    

[AR1-GigabitEthernet0/0/1]display ip routing-table 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 7        Routes : 7        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

       10.0.0.0/24  Direct  0    0           D   10.0.0.254      GigabitEthernet
0/0/1
     10.0.0.254/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/1
     10.0.0.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet
0/0/1
      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0
      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0
127.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0
255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0
~~~


## 6.7 路由优先级

### 1) 概念

- 当路由器从多种不同的途径获知到达同一个目的网段的路由(这些路由的目的网络地址及网络掩码均相同）日时，路由器会比较这些路由的优先级，优选优先级值最小的路由。
- 路由来源的优先级值（Preference）越小代表加入路由表的优先级越高
- 拥有最高优先级的路由将被添加进路由表。

### 2) 比较过程

![[Pasted image 20250806003526.png]]
- RTA通过动态路由协议OSPF和手动配置的方式都发现了到达10.0.0.0/30的路由，此时会比较这两条路由的优先级，优选优先级值最小的路由。
- 每一种路由协议都有相应的优先级。
- OSPF拥有更优的优先级，因此通过OSPF学习到的路由被添加到路由表中。

### 3) 路由优先级 - 常见默认值

| 路由来源 | 路由类型     | 缺省优先级 |
| ---- | -------- | ----- |
| 直连   | 直连路由     | 0     |
| 静态   | 静态路由     | 60    |
| 动态路由 | OSPF内部路由 | 10    |
| 动态路由 | OSPF外部路由 | 150   |

### 4) 度量值

![[Pasted image 20250806004330.png]]

- 当路由器通过某种路由协议发现了多条到达同一个目的网络的路由时(拥有相同的路由优先级），度量值将作为路由优选的依据之一。
- 路由度量值表示到达这条路由所指目的地址的代价。
- 一些常用的度量值有：跳数、带宽、时延、代价、负载、可靠性等。
- 度量值数值越小越优先，度度量值最小路由将会被添加到路由表中。
- 度量值很多时候被称为开销(Cost)

> RIP其中被淘汰的原因之一就是 RIP 只考虑跳数的多少，不考虑带宽等参数。

### 5) 最长匹配原则
当路由器收到一个IP数据包时，会将数据包的目的IP地址与自己本地路由表中的所有路由表项进行逐位（Bit-By-Bit）比对，直到找到匹配度最长的条目，这就是最长前缀匹配机制。 

![[Pasted image 20250806005421.png]]



### 6) 最终路由转发流程

1. **学习路由：** 路由器通过直连、静态配置、OSPF、RIP 等多种方式学习到去往各个目标网络的路由。
    
2. **筛选路由（应用路由优先级）：**
    
    - 对于**同一个目标网络前缀**（例如 `10.1.1.0/24`），如果从多个协议都学到了，路由器会使用 **路由优先级（AD值）** 来裁决。
    - AD 值最小的协议胜出，其路由被选为“最佳路由”，准备放入全局路由表。
    - _补充：如果同一个协议（如OSPF）提供了多条去往同一网络的路径，则会使用该协议内部的**度量值（Metric）**，如 OSPF 的 Cost，来选择最优路径。_
3. **生成路由表：** 经过优先级和度量值的筛选后，最终的“冠军”路由被安装到路由器的全局路由表中。
    
4. **转发数据包（应用最长匹配原则）：**
    
    - 当一个数据包到达路由器时，路由器提取其目的IP地址。
    - 路由器用这个IP地址去**查询整个路由表**，可能会发现有多条路由都能匹配（因为掩码不同）。
    - 此时，路由器应用**最长匹配原则**，选择那条掩码最长的路由作为最终的转发路径，并将数据包从对应的接口发往下一跳。

**简单概括：**

- **路由优先级**：决定了“谁有资格进场比赛”（谁的路由能进路由表）。
- **最长匹配原则**：决定了“比赛开始后，谁能赢得冠军”（数据包来了之后，用哪条路由）。

## 6.8 静态路由

- 静态路由由网络管理员手动配置，配置方便，对系统要求低，适用于拓扑结构简单并且稳定的小型网络。
- 缺点是不能自动适应网络拓扑的变化，，需要人工干预。
- RTA上转发目的地址属于20.1.1.0/24的报文，在只有直连路由的情况下没有路由匹配。此时可以通过手动配置静态路由，使RTA发送前往20.1.1.0/24网段的报文交给下一跳10.0.0.2转发

### 1) 静态路由配置

1. 关联下一条 IP 的方式
	~~~shell
	[R2] ip route-static 192.168.1.0 24 10.1.1.1
	~~~
2. 关联出接口的方式
	~~~shell
	[R1] ip route-static 192.168.2.0 24 GigabitEthernet 0/0/0
	~~~
3. 关联出接口和下一跳IP方式
	~~~shell
	[R1] ip route-static 192.168.2.0 24 GigabitEthernet 0/0/0 10.1.1.2
	~~~
在创建静态路由时，可以同时指定出接口和下一跳。对于不同的出接口类型，也可以只指定出接口或只指定下一跳。
对于点到点接口（如串口），只需指定出接口。
对于广播接口（如以太网接口）和vT（Virtual-template）接口，必须指定下一跳。

### 4) 缺省路由

- 缺省路由是一种特殊的路由，当报文没有在路由表中找到匹配的具体路由表项时才使用的路由。如果报文的目的地址不能与路由表的任何目的地址相匹配，那么该报文将选取缺省路由进行转发。
- 缺省路由在路由表中的形式为0.0.0.0/0，缺省路由也被叫做默认路由。

![[Pasted image 20250806210046.png]]
缺省路由一般用于企业网络出口，配置一条缺省路由让出口设备能够转发前往Internet上任意地址的IP报文。

## 6.9 动态路由

动态路由协议能够自动发现和生成路由，并在拓扑变化时及时更新路由，可以有效减少管理人员工作量，更适用于大规模网络。

### 1) 动态路由分类

按工作区域分类:
IGP（Interior GatewayProtocols,内部网关协议）：
- RIP
- OSPF
- IS-IS
EGP（ExteriorGatewayProtocols外部网关协议）
- BGP

按工作机制及算法分类：
(Distance Vector Routing Protocols，距离矢量路由协议）
- RIP
(Link-StateRoutingProtocols，链路状态路由协议)
- OSPF
- IS-IS

## 6.10 高级路由特性

### 1) 路由递归

- 路由必须有直连的下一跳才能够指导转发，但是路由生成时下一跳可能不是直连的，因此需要计算出一个直连的下一跳和对应的出接口，这个过程就叫做路由递归。
- 路由递归也被称为路由迭代。

### 2) 等价路由

![[Pasted image 20250806221240.png]]

- 路由表中存在等价路由之后，前往该目的网段的IP报文路由器会通过所有有效的接口、下一跳转发，这种转发行为被称为负载分担。

### 3) 浮动路由

- 静态路由支持配置时手动指定优先级，可以通过配置目的地址/掩码相同、优先级不同、下一跳不同的静态路由，实现转发路径的备份
- 浮动路由是主用路由的备份，保证链路故障时提供备份路由。主用路由下一跳可达时该备份路由不会出现在路由表。

![[Pasted image 20250806221211.png]]

### 4) 路由汇总

CIDR
- CIDR（classlessinter-domainrouting，无类别域间路由）采用iP地址加掩码长度来标识网络和子网，而不是按照传统A、B、C等类型对网络地址进行划分。
- CIDR容许任意长度的掩码长度，将IP地址看成连续的地址空间，可以使用任意长度的前缀分配，多个连续的前缀可以聚合成一个网络，该特性可以有效减少路由表条目数量。

汇总需求
- 子网划分、VLSM解决了地址空间浪费的问题，但同时也带了新的问题：路由表中的路由条目数量增加。
- 为减少路由条目数量可以使用路由汇总。

# 七、传输层详解

参考文档：[计算机网络-第三章-传输层 - Crispy·Candy - 博客园](https://www.cnblogs.com/CrispyCandy/articles/17558271.html)

可靠的、保序的传输： TCP(字节流的服务)
- 多路复用、解复用
- 拥塞控制
- 流量控制
- 建立连接

不可靠、不保序的传输：UDP(数据包的服务)
- 多路复用、解复用
- 没有为尽力而为的IP服务添加更多的其它额外服务
    可以理解为UDP仅仅是将==主机到主机==的服务转变为==进程到进程==的服务，除此之外没有其他作用 
都不提供的服务： 延时保证 带宽保证
## 7.1 数据封装

### 1) TCP 报文格式

![[Pasted image 20250806231600.png]]
- Source Port：源端口，标识哪个应用程序发送。长度为16比特。
- Destination Port：目的端口，标识哪个应用程序接收。长度为16比特。
- Sequence Number：序号字段。TCP链接中传输的数据流每个字节都编上一个序号。序号字段的值指的是本报文段所发送数据的第一个字节的序号。长度为32比特。
- Acknowledgment Number：确认序列号，是期望收到对方下一个报文段数据的第1个字节的序号，即上次已成功接收到的数据段的最后一个字节数据的序号加1。只有Ack标识为1，此字段有效。长度为32比特。
- Header Length：头部长度，指出TCP报文头部长度，以32比特（4字节）为计算单位。若无选项内容，则该字段为5，即头部为20字节。
- Reserved：保留，必须填0。长度为6比特。
- Control bits：控制位，包含FIN、ACK、SYN等标志位，代表不同状态下的TCP数据段。


### 2) UDP 报文格式

![[Pasted image 20250806231816.png]]
- Source Port:源端口，标识哪个应用程序发送。长度为16比特。
- Destination Port:目的端口，标识哪个应用程序接收。长度为16比特。
- Length:该字段指定UDP报头和数据总共占用的长度。可能的最小长度是8字节，因为UDP报头已经占用了8字节。由于这个字段的存在，UDP报文总长不可能超过65535字节（包括8字节的报头，和65527字节的数据）。
- Checksum:覆盖UDP头部和UDP数据的校验和，长度为16比特。

## 7.2 多路复用/解复用

概念

- 多路(复用/解复用)：一个TCP/UDP实体上有很多应用进程借助其发送

在发送方主机多路复用
- 从多个套接字接收来自多个进程的报文，根据套接字对应的IP地址和端口号等信息==对报文段用头部加以封装== (该头部信息用于以后的解复用)
在接收方主机多路解复用
- 根据报文段的头部信息中的IP地址和端口号将接收到的报文段发给正确的套接字(和对应的应用进程)

工作原理

- 解复用作用：TCP或者UDP实体采 用哪些信息，将报文段的==数据部分== 交给正确的socket，从而交给正确 的进程
- 主机收到IP数据报
    - 每个数据报有源IP地址和目标地址
    - 每个数据报承载一个传输层报文段
    - 每个报文段有一个源端口号和目标端口号 (特定应用有著名的端口号)
- 主机联合使用IP地址和端口号将报文段发送给合适的套接字

### 7.3 TCP/IP 三次握手

任何基于TCP的应用，在发送数据之前，都需要由TCP进行“三次握手”建立连接。

![[Pasted image 20250806234335.png]]
![[Pasted image 20250806234940.png]]
- 第一次：SYNbit + seq
- 第二次：（SYNbit + seq） + （ACKbit + + ACKnum）
- 第三次：ACKbit + ACKnum（+ data）

> 第三次握手也会捎带将数据传过去的

| 属性             | 说明            |
| -------------- | ------------- |
| SYNbit=1       | 请求建立连接        |
| Seq = x        | 建立请求的时候选择初始信号 |
| ACKbit = 1     | 表明该信号是ACK信号   |
| ACKnum = x + 1 | 表示同意Seq=x的请求  |
|                |               |

TCP使用序列号和确认序列号字段实现数据的可靠和有序传输。

![[Pasted image 20250806234707.png]]
### 7.4 TCP/IP 四次挥手

当数据传输完成，TCP需要通过“四次挥手”机制断开TCP连接，释放系统资源。
![[Pasted image 20250806235142.png]]

![[Pasted image 20250806234445.png]]
# 八、OSPF

- OSPF是典型的链路状态路由协议，是目前业内使用非常广泛的IGP协议之一。
- 目前针对IPv4协议使用的是0SPFVersion2（RFC2328）；针对IPv6协议使用oSPFVersion（RFC2740）。如无特殊说明本章后续所指的OSPF均为OSPFVersion2。
- 运行OSPF路由器之间交互的是LS（Link State，链路状态）信息，而不是直接交互路由。LS信息是OSPF能够正常进行拓扑及路由计算的关键信息。
- OSPF支持VLSM（VariableLengthSubnetMask，可可变长子网掩码），支持手工路由汇总。

## 8.1 距离矢量路由协议

运行距离矢量路由协议的路由器周期性的泛洪自己的路由表。通过路由的交互，每台路由器都从相邻的路由器学习到路由，并且加载进自己的路由表中。

## 8.2 链路状态路由协议

好的，我们来系统地总结一下**链路状态路由协议 (Link-State Routing Protocol)** 的工作流程。

相比于“道听途说”的距离矢量协议，链路状态协议的核心思想是 **“构建上帝视角的地图”** 。网络中的每一台路由器都像一个测绘员，它们共同协作，最终让每台路由器都拥有一份完全相同的、详细的网络“拓扑地图”。

最典型的链路状态协议是 **OSPF (Open Shortest Path First)** 和 **IS-IS (Intermediate System to Intermediate System)**。我们就以 OSPF 为例来讲解其工作流程。


### 1) 关键术语

1. 区域
	- OSPF Area用于标识一个OSPF的区域
	- 区域是从逻辑上将设备划分为不同的组，每个组用区域号（Area ID）来标识。
	
2. Router-ID
	- Router-ID（Router Identifier，路由器标识符），用于在一个oSPF域中唯一地标识一台路由器。
	- Router-ID的设定可以通过手工配置的方式，或使用系统自动配置的方式。
	
3. 度量值
	**度量值（Metric）** 用于计算到达目标网络的最优路径。OSPF的度量值基于接口的 **带宽（Bandwidth）**，通过特定公式计算得出。以下是关于OSPF度量值的详细说明和配置方法：
		Cost = Reference Bandwidth / 接口带宽 (bps)
		OSPF计算路径时会累加沿途所有出接口的Cost值，选择**总Cost最小**的路径。
	修改接口带宽（临时影响）
		interface GigabitEthernet0/0
		bandwidth 50000  # 手动设置带宽为50Mbps（单位：Kbps）	
	
4. 区域（Area）与骨干区域（Area 0）
	**区域（Area）** 和 **骨干区域（Area 0）** 是分层网络设计的核心概念，用于优化路由计算、减少资源消耗并增强扩展性。
		~**普通区域（Non-Backbone Area）**  
		    - 所有非Area 0的区域（如Area 1、Area 2），必须直接或通过虚链路连接到Area 0。
		**特殊区域**（用于进一步优化）：
		    - **末节区域（Stub Area）**：禁止Type 5 LSA（外部路由），由ABR下发默认路由。
		    - **完全末节区域（Totally Stubby Area）**：禁止Type 3/4/5 LSA，仅保留ABR下发的默认路由。
		    - **NSSA（Not-So-Stubby Area）**：允许引入少量外部路由（Type 7 LSA），由ABR转换为Type 5 LSA。
		**骨干区域**
			- **要求**：所有OSPF网络必须存在Area 0，且其他区域必须直接或间接与其相连。
			- **路由中转站**：区域间路由（Inter-Area Routing）必须通过Area 0转发。
			- **全互联拓扑**：Area 0内的路由器需保持全连通性（避免分区）。
		 
5. 链路状态数据库（LSDB）
	- LSDB保存了本区域内所有路由器的链路状态信息（通过LSA描述），形成一张“拓扑地图”。
	- 同一区域内的所有路由器必须维护完全相同的LSDB（通过洪泛机制同步）。
	
6. 邻居（Neighbor）与邻接（Adjacency）
	- **邻居**
		台OSPF路由器通过 **Hello协议**发现彼此，并在相同区域和链路上达成基本参数一致（如Area ID、Hello/Dead间隔等），即成为邻居。
		- 双方仅交换**Hello报文**（不交换LSA）。
		- 邻居关系稳定后停留在**2-Way状态**。
	- 邻接
		在邻居基础上，双方同步**完整的LSDB**并建立路由计算所需的链路状态信息。
		- 双方交换**DBD、LSR、LSU、LSAck**报文。
		- 仅与特定邻居建立邻接（如DR/BDR或点到点链路的所有邻居）。
		- **邻接建立的常用场景
			- 广播多路访问
			- 点到点链路


## 8.3 工作原理:

### 1) 链路状态通信

链路状态路由OSPF 工作原理：
1)  LSA泛洪

与距离矢量路由协议不同，链路状态路由协议通告的的是链路状态而不是路由表。运行链路状态路由协议的路由器之间首先会建立一个协议的邻居关系，然后彼此之间开始交互LSA（LinkStateAdvertisement，链路状态通告）。

![[Pasted image 20250807005736.png]]

 2)  LSDB组建

每台路由器都会产生LSAs，路由器将接收到的LSAs放入自己的LSDB（LinkStateDataBase，链路状态数据库）；路由器通过LSDB，掌握了全网的拓扑。

大白话说就是将各个路由器所产生的拓扑（地图），收集起来，形成一个全网的拓扑（完整地图），然后在转发的各个路由器上。
3)  SPF计算
  
每台路由器基于LSDB，使用sPF（ShortestPathFirst，最短路径优先）算法进行计算。每台路由器都计算出一棵以自己为根的、无环的、拥有最短路径的“树”。有了这棵“树”，路由器就已经知道了到达网络各个角落的优选路径。

4)  路由表生成

最后，路由器将计算出来的优选路径，加载进自己的路由表（RoutingTable）。

### 2) 邻居建立过程

OSPF通过状态机驱动邻居关系演进，最终形成邻接（Adjacency）。以下是典型广播网络中的流程：
#### **1. Down** → **Init**

- **触发条件**：路由器发送Hello报文（目标地址 `224.0.0.5`）。
- **动作**：
    
    - 检查Hello报文中的 **Area ID**、 **认证**、 **网络掩码**等参数是否匹配。
    - 若参数合法，接收方将发送者加入邻居列表，但尚未确认双向通信。
    
- **抓包特征**：
    
    ~~~ plaintext
    OSPF Hello Packet:
    - Neighbors List: Empty    # Init状态下不包含对端Router-ID
    ~~~

---
#### **2. Init** → **2-Way**

- **关键动作**：
    
    - 当收到的Hello报文中包含自己的 **Router-ID**时，标志双向通信建立。
    - 如果是 **广播/NBMA网络**，此时开始DR/BDR选举（依据优先级和Router-ID）。
    
- **状态验证命令**：
    ~~~bash
    show ip ospf neighbor
	# 输出示例：
	Neighbor ID     Pri   State      Dead Time
	192.168.1.2     1     2-WAY      00:00:37
    ~~~

---
#### **3. 2-Way** → **ExStart**

- **条件**：
    
    - 仅与DR/BDR，点对点邻居进入此阶段（非DR/BDR的路由器间保持在2-Way）。
    
- **动作**：
    
    - 主从选举（Master/Slave）：通过比较Router-ID确定谁控制DBD交换。
    - 开始交换 **DBD（Database Description）报文**（携带LSDB摘要）。
    
- **抓包关键字段**：
    ~~~plaintext
    OSPF DBD Packet:
	  - I (Initial) Bit: 1      # 表示会话初始化
	  - M (More) Bit: 1         # 表示后续还有DBD
	  - MS (Master/Slave): 1    # 1=Master, 0=Slave
    ~~~

---
#### **4. ExStart** → **Exchange** → **Loading**

- **Exchange阶段**：
    
    - 交换DBD摘要，对比LSDB差异。
    - 通过 **LSR（Link State Request）** 请求缺失的LSA。
    
- **Loading阶段**：
    
    - 通过 **LSU（Link State Update）** 发送完整的LSA数据。
    - 每收到LSU后回复 **LSAck**确认。
    
- **验证命令**：
    ~~~bash
    debug ip ospf packets    # 查看LSR/LSU交互（慎用）
	show ip ospf database    # 确认LSDB同步
    ~~~

#### **5. Loading** → **Full**

- **最终状态**：
    
    - 双方LSDB完全同步，邻接关系建立完成。
    - 路由器基于LSDB计算最短路径树（SPF）。
    
- **标志字段**：
    ~~~bash
    show ip ospf neighbor
	# 输出中State显示FULL/DR、FULL/BDR或FULL/-
    ~~~

## 8.4 OSPF 区域设计

在一个小规模网络中，所有 OSPF 路由器可以放在同一个区域（通常是骨干区域 Area 0）里，这被称为“单区域 OSPF”。但随着网络规模的扩大，单区域 OSPF 会面临以下问题：

1. **路由表庞大 (Large Routing Table)**：每个路由器都需要存储整个网络的所有链路状态信息（LSA），导致路由表非常大，消耗大量内存。
2. **频繁的 SPF 计算 (Frequent SPF Calculation)**：网络中任何一个链路状态的微小变化（如端口 UP/DOWN），都会触发全网所有路由器重新进行 SPF（最短路径优先）算法计算，消耗大量 CPU 资源。
3. **LSA 泛洪开销大 (Extensive LSA Flooding)**：链路状态通告（LSA）会在整个区域内泛洪。网络越大，LSA 的泛洪范围和数量就越多，占用网络带宽。
4. **网络收敛慢 (Slow Convergence)**：网络越大，拓扑变化后，所有路由器完成 SPF 计算并更新路由表所需的时间就越长，网络收敛速度变慢。

**通过划分区域（多区域 OSPF），我们可以有效解决以上问题，带来以下优势：**

- **缩小路由表**：通过在区域边界进行路由汇总，非骨干区域的路由器只需要知道区域内路由和一条指向骨干区域的汇总/默认路由即可，大大减小了路由表条目。
- **减少 SPF 计算**：拓扑变化被限制在区域内部。一个区域内的链路变化，不会触发其他区域的路由器进行 SPF 计算，降低了 CPU 负担。
- **限制 LSA 泛洪**：大部分 LSA（Type 1, Type 2）只在区域内部泛洪，不会穿越区域边界，减少了网络带宽消耗。
- **提高网络稳定性**：一个区域的网络不稳定（如链路频繁抖动），不会影响到其他区域的稳定性，实现了故障隔离。

选择合适的区域类型是设计的关键：

|区域类型|描述|LSA 类型|适用场景|
|---|---|---|---|
|**标准区域 (Standard Area)**|默认区域类型。可以接收和发送任何类型的 LSA。|Type 1, 2, 3, 4, 5|骨干区域或需要承载外部路由的大型区域。|
|**末梢区域 (Stub Area)**|**不接收** 外部路由（Type 5 LSA）。ABR 会向该区域注入一条指向外部的 **默认路由** (Type 3 LSA)。|Type 1, 2, 3|简单的分支网络，不需要知道具体的外部路由，只需要能访问外部网络即可。|
|**完全末梢区域 (Totally Stubby Area)**|**不接收** 外部路由（Type 5 LSA）和区域间路由（Type 3 LSA）。ABR 只向该区域注入一条 **默认路由**。|Type 1, 2, 和一条默认路由|极简的分支网络，所有非本区域的流量都通过默认路由发往 ABR。这是思科私有的特性，但被广泛支持。|
|**不那么末梢的区域 (NSSA)**|Stub Area 的变种。它本身不接收来自其他区域的外部路由（Type 5 LSA），但 **允许** 自身连接一个外部网络，并将该外部路由以 **Type 7 LSA** 的形式注入 OSPF 网络。|Type 1, 2, 3, 7|一个分支机构既想简化路由表（成为 Stub），又需要将自己的特定外部路由（如独立的 Internet 连接）通告给全网。|
|**完全 NSSA (Totally NSSA)**|NSSA 和 Totally Stubby Area 的结合体。不接收 Type 3 和 Type 5 LSA，但允许自己产生 Type 7 LSA。ABR 只注入一条默认路由。|Type 1, 2, 7, 和一条默认路由|与 NSSA 场景类似，但希望路由表更加简化。|

## 8.5 OSPF网络类型

OSPF 设计了不同的网络类型，是为了适应各种底层链路技术（如以太网、帧中继、PPP 等）的特性。

OSPF 主要有以下五种网络类型，其中前四种最为常见：

| 网络类型                                  | 是否选举DR/BDR | 邻居发现方式      | 默认 Hello/Dead 时间 | 典型应用场景                    |
| ------------------------------------- | ---------- | ----------- | ---------------- | ------------------------- |
| **Broadcast (广播多路访问)**                | **是**      | 自动 (通过组播)   | 10秒 / 40秒        | 以太网 (Ethernet)            |
| **Non-Broadcast Multi-Access (NBMA)** | **是**      | 手动配置 (通过单播) | 30秒 / 120秒       | 帧中继 (Frame Relay), X.25   |
| **Point-to-Point (点对点)**              | **否**      | 自动 (通过组播)   | 10秒 / 40秒        | 专线, PPP, HDLC, GRE Tunnel |
| **Point-to-Multipoint (点到多点)**        | **否**      | 自动 (通过组播)   | 30秒 / 120秒       | 部分网状的 NBMA 环境 (如星型拓扑)     |
| **Loopback (环回)**                     | **否**      | (不适用)       | (不适用)            | 逻辑接口，用于路由ID和管理            |

#### 1. Broadcast (广播多路访问)

这是最常见的 OSPF 网络类型。

- **工作机制**：
    - 假设网络中的所有路由器都可以直接相互通信（像在一个局域网中）。
    - 通过组播地址 `224.0.0.5` 发送 Hello 包来自动发现邻居。
    - 为了减少 LSA 泛洪和邻接关系的数量，会选举一个 **指定路由器 (DR)** 和一个 **备用指定路由器 (BDR)**。
    - 网络中其他所有路由器 (DROther) 只与 DR 和 BDR 建立完全邻接关系。
    - DROther 将 LSA 更新发送给 DR (使用组播地址 `224.0.0.6`)，再由 DR 统一泛洪给该网段的所有其他 OSPF 路由器 (使用组播地址 `224.0.0.5`)。
- **适用场景**：
    - 以太网 (Ethernet) 接口。这是以太网接口的默认 OSPF 网络类型。
- **关键点**：DR/BDR 的选举是为了优化多路访问网络中的 OSPF 通信。

#### 2. Non-Broadcast Multi-Access (NBMA, 非广播多路访问)

这种类型用于那些支持多台设备连接、但 **不支持** 广播或组播的链路层技术。

- **工作机制**：
    - 由于链路层不支持广播/组播，OSPF **无法自动发现邻居**。
    - 必须在路由器上手动使用 `neighbor <ip-address>` 命令来 **静态指定** 邻居的 IP 地址。Hello 包将以 **单播** 的形式发送给这些指定的邻居。
    - 尽管邻居是手动指定的，NBMA 网络 **仍然会选举 DR 和 BDR**。这可能会引发问题，因为在典型的星型拓扑中，两个“分支”路由器（Spoke）之间可能无法直接通信，但 DR 选举要求所有路由器都能互相通信。
- **适用场景**：
    - 帧中继 (Frame Relay)、X.25、ATM。这些是传统 WAN 技术，现在已不常用。
- **关键点**：需要手动指定邻居，并且 DR/BDR 的选举机制可能不适用于所有 NBMA 拓扑。

#### 3. Point-to-Point (点对点)

用于连接且仅连接两台路由器的链路。

- **工作机制**：
    - 网络中只有两个节点，因此 **不需要选举 DR 和 BDR**，大大简化了邻接过程。
    - 通过组播地址 `224.0.0.5` 自动发现对端的邻居。
    - 一旦 Hello 包交换成功，两台路由器直接建立完全邻接关系。
- **适用场景**：
    - 串行接口上的 PPP 或 HDLC 封装。
    - GRE 隧道接口 (默认类型)。
    - 在只有两台路由器连接的以太网链路上，**强烈建议** 将网络类型手动修改为 Point-to-Point，以避免不必要的 DR 选举，从而加快收敛速度。

#### 4. Point-to-Multipoint (点到多点)

这是一种混合类型，通常被看作是解决 NBMA 网络问题的一种方案。

- **工作机制**：
    - 它将一个非广播网络（如星型拓扑的帧中继）看作是一系列 **点对点链路的集合**。中心路由器 (Hub) 会与每个分支路由器 (Spoke) 形成一个逻辑上的点对点连接。
    - **不选举 DR 和 BDR**，从而避免了 NBMA 中 Spoke 之间无法通信的问题。
    - 邻居可以自动发现（如果底层支持伪广播）或手动指定。
    - 一个特点是，它会将到达邻居的路由通告为一条 `/32` 的主机路由，同时也会通告宣告此接口的网段路由。
- **适用场景**：
    - 当 NBMA 网络拓扑不是全网状（Full-Mesh）时，例如星型拓扑（Hub-and-Spoke），使用 Point-to-Multipoint 是一个比 NBMA 更好的选择。

#### 5. Loopback (环回)

这是一个特殊的网络类型，只用于环回接口 (Loopback Interface)。

- **工作机制**：
    - OSPF 总是将环回接口视为一个末梢网络 (Stub Network)。
    - 它总是以 `/32` 的主机路由形式被通告到 OSPF 网络中，无论你在接口上配置了什么样的子网掩码。
    - 这非常有用，因为环回接口只要路由器开机就是 `UP` 状态，非常稳定。通常被用作：
        - **稳定的 Router ID**：OSPF 进程启动时会优先选择环回接口的最高 IP 地址作为 Router ID。
        - **稳定的管理地址**：可以通过这个地址来 Telnet/SSH 管理设备。
        - **BGP 等其他协议的 Peering 地址**：使用环回地址建立 iBGP 邻居关系，可以不依赖于物理链路的稳定性。


## 8.6 OSPF 协议报文与LSA详解

### 1) OSPF报文类型

OSPF有五种类型的协议报文。这些报文在OSPF路由器之间交互中起不同的作用。

| 报文名称                 | 报文功能                                              |
| -------------------- | ------------------------------------------------- |
| Hello                | 周期性发送，用来发现和维护OSPF邻居关系。                            |
| Database Description | 描述本地LSDB的摘要信息，用于两台设备进行数据库同步。                      |
| Link State Request   | 用于向对方请求所需要的LSA。设备只有在OSPF邻居双方成功交换DD报文后才会向对方发出LSR报文 |
| LinkStateUpdate      | 用于向对方发送其所需要的LSA                                   |
| Link State ACK       | 用来对收到的LSA进行确认                                     |
### 2) LSA 类型

| LSA 类型     | 名称 (Name)                         | 产生者 (Originator) | 泛洪范围 (Flooding Scope) | 简单描述                             |
| ---------- | --------------------------------- | ---------------- | --------------------- | -------------------------------- |
| **Type 1** | **Router LSA (路由器LSA)**           | 每个路由器            | **区域内 (Intra-Area)**  | "我是谁，我的直连接口和邻居有哪些。"              |
| **Type 2** | **Network LSA (网络LSA)**           | DR (指定路由器)       | **区域内 (Intra-Area)**  | "在这个多路访问网络上，都有哪些路由器。"            |
| **Type 3** | **Summary LSA (网络摘要LSA)**         | ABR (区域边界路由器)    | **相关区域 (Inter-Area)** | "要访问区域X的某个网络，请来找我。"              |
| **Type 4** | **ASBR Summary LSA (ASBR摘要LSA)**  | ABR (区域边界路由器)    | **整个OSPF域**           | "要找那个能通往外部世界的ASBR吗？它在那，可以从我这里走。" |
| **Type 5** | **External LSA (外部LSA)**          | ASBR (自治系统边界路由器) | **整个OSPF域 (特殊区域除外)**  | "我这里有一条去往外部网络（如Internet）的路径。"    |
| **Type 7** | **NSSA External LSA (NSSA外部LSA)** | NSSA区域内的ASBR     | **NSSA区域内**           | "我是NSSA区域里的特殊外部路径，请ABR帮我通告出去。"   |


### 3) LSA传播范围与老化机制


LSA 老化机制是一套确保 LSDB 中的信息不会“过期”或“僵死”的自我维护体系。它主要依赖两个关键定时器和一个特殊机制。

1. LSA Age 字段

每个 LSA 内部都有一个 16 位的 **Age 字段**，单位是秒。

- 当一个 LSA 被创建时，Age 初始为 0。
- 当 LSA 在路由器 LSDB 中存放时，其 Age 值会随着时间线性增长。
- 当 LSA 在网络中被泛洪时，每经过一跳路由器，其 Age 值也会增加一个小的传输延迟。

2. LSRefreshTime (链路状态刷新时间)

- **默认值**: **1800 秒 (30 分钟)**
- **机制**: OSPF 网络需要确认所有链路信息都是“鲜活”的。因此，LSA 的**始发路由器**有责任**每隔 30 分钟**重新生成并泛洪一次它自己产生的所有 LSA，即使 LSA 的内容没有任何变化。
- **过程**: 重新泛洪时，LSA 的内容不变，但**序列号会加 1**，并且 **Age 会被重置为 0**。网络中的其他路由器收到这个“刷新”的 LSA 后，会用它来替换掉自己 LSDB 中那个 Age 已经增长到 1800 秒左右的旧版本，并重置 Age 计时。
- **目的**: 周期性地确认信息的有效性，防止信息因意外丢失而过期。

3. MaxAge (最大老化时间)

- **默认值**: **3600 秒 (60 分钟)**
- **机制**: 这是 LSA 的“生命终点”。如果一个 LSA 在某台路由器的 LSDB 中，其 Age 增长到了 3600 秒，这台路由器就会认为该 LSA 无效，并将其从自己的 LSDB 中清除。
- **触发场景**: 通常，这种情况发生在 LSA 的始发路由器宕机或与网络断开连接，导致它无法在 30 分钟时刷新其 LSA。当时间达到 60 分钟后，全网都会“公认”这条 LSA 失效，并将其删除，从而触发 SPF 重新计算，清除与该 LSA 相关的失效路由。

4. 强制老化 (Premature Aging)

- **机制**: 等待 60 分钟才能清除一条失效路由，收敛速度太慢。因此，OSPF 有一个主动清除的机制。当始发路由器想要立即撤销一条 LSA 时（例如，某个接口被 shutdown），它会执行“强制老化”。
- **过程**: 始发路由器会立刻重新泛洪这条 LSA，但会将其 **Age 字段直接设置为 MaxAge (3600 秒)**。
- **效果**: 网络中任何收到这条“带毒”LSA 的路由器，会立即发现它的 Age 已经是 MaxAge，于是会马上将对应的条目从自己的 LSDB 中删除，并快速泛洪这个“删除通告”给邻居。
- **目的**: 实现快速收敛。这是一种高效的、主动的 LSA 删除机制。

- **传播范围** 由 **LSA 类型** 和 **区域边界 (ABR)** 共同决定，这是 OSPF 可扩展性的基石。Type 1/2 局限于区域内，Type 3/4/5/7 则负责跨区域或外部通信，并在边界上被严格管控。
- **老化机制** 是 OSPF 的稳定性和自我修复能力的保障。**LSRefreshTime (30分钟)** 周期性地确认信息有效性，而 **MaxAge (60分钟)** 和 **强制老化** 机制则确保了失效信息能够被及时、可靠地从网络中清除。

### 4) SPF算法

在OSPF协议中， **SPF算法（Shortest Path First，最短路径优先算法）**，也称为 **Dijkstra算法**，是计算最优路径的核心机制。它基于链路状态数据库（LSDB）构建网络拓扑图，并计算出到达所有目标网络的最短路径树（SPT）。以下是关于SPF算法的深度解析，涵盖原理、计算步骤、优化及实际应用场景：

## 8.7 OSPF三大表项

OSPF有三张重要的表项，**OSPF邻居表**、**LSDB表**和**OSPF路由表**。

### 1) 邻居表

- OSPF在传递链路状态信息之前，需先建立OSPF邻居关系。
- OSPF的邻居关系通过交互Hello报文建立
- OSPF邻居表显示了osPF路由器之间的邻居状态，使用`display ospf peer`查看。

### 2) LSDB 表

- LSDB会保存自己产生的及从邻居收到的LSA信息，本例中R1的LSDB包含了三条LSA。
- Type标识LSA的类型，AdvRouter标识发送LSA的路由器。
- 使用命令行`display ospf lsdb查看LSDB表

### 3) OSPF路由表

- OSPF路由表和路由器路由表是两张不同的表项。本例中OSPF路由表有三条路由。
- OSPF路由表包含Destination、Cost和NextHop等指导转发的信息。
- 使用命令`display ospf routing`查看osPF路由表。


## 8.8 高级特性

好的，我们来探讨一下 OSPF 的一些高级特性。这些特性主要用于在复杂网络环境中进行 **优化、增强安全性和提高可靠性**。

掌握了这些特性，你就可以从“让 OSPF 跑起来”提升到“让 OSPF 跑得好、跑得稳”。

我将介绍以下几个关键的高级特性：

1.  **路由汇总 (Route Summarization)**
2.  **虚链路 (Virtual Link)**
3.  **OSPF 认证 (Authentication)**
4.  **默认路由分发 (Default Route Distribution)**
5.  **路径成本调整 (Path Cost Manipulation)**
6.  **BFD for OSPF (快速故障检测)**
7.  **Graceful Restart / NSF (平滑重启)**

---

### 1. 路由汇总 (Route Summarization)

这是 OSPF 区域设计中最核心的优化手段，虽然概念基础，但用好它需要高级的规划。

*   **是什么？** 将多条明细路由聚合成一条或少数几条汇总路由。
*   **为什么需要？**
    *   **减小路由表**：非骨干区域的路由器不需要学习其他区域所有明细路由。
    *   **增强稳定性**：一个区域内的链路抖动（导致明细路由 UP/DOWN）不会传递到其他区域，因为汇总路由保持不变。这大大减少了全网的 SPF 计算。
    *   **减少 LSA 泛洪**：汇总后，通告的 Type 3 LSA 数量会急剧减少。
*   **如何实现？**
    *   **区域间汇总 (Inter-Area Summarization)**：在 **ABR** 上配置，将一个区域内的路由汇总后通告给其他区域。
        ```cisco
        ! 在 ABR 上配置
        router ospf 1
         area <area-id> range <prefix> <netmask>
        
        ! 示例: 将 Area 10 内所有 10.10.x.x 的路由汇总成一条
        area 10 range 10.10.0.0 255.255.0.0
        ```
    *   **外部路由汇总 (External Summarization)**：在 **ASBR** 上配置，将重分发的外部路由进行汇总。
        ```cisco
        ! 在 ASBR 上配置
        router ospf 1
         summary-address <prefix> <netmask>
        
        ! 示例: 将所有重分发的 172.16.x.x 外部路由汇总
        summary-address 172.16.0.0 255.255.0.0
        ```
*   **注意事项**：路由汇总依赖于优秀的 **IP 地址连续性规划**。随意分配的 IP 地址很难进行有效汇总。

---

### 2. 虚链路 (Virtual Link)

这是一个解决特定 OSPF 设计缺陷的“补丁”工具。

*   **是什么？** 一条逻辑上的隧道，穿越一个非骨干区域（Transit Area），用来将一个孤立的区域或一个不与 Area 0 直接相连的 ABR 连接到骨干区域。
*   **为什么需要？** 解决两个经典问题：
    1.  **非连续骨干区域**：由于网络并购或规划失误，Area 0 被分割成了两块，中间隔着一个非骨干区域。
    2.  **孤立区域**：一个非骨干区域无法物理直连到 Area 0，必须“借道”另一个非骨干区域。
*   **如何实现？** 在“过境区域”（Transit Area）两端的 ABR 上相互指定对方的 Router ID 来建立虚链路。
    ```cisco
    ! 在两个 ABR 上相互配置
    ! 假设 R1 和 R2 之间通过 Area 1 连接，需要建立虚链路
    ! R1 Router-ID: 1.1.1.1, R2 Router-ID: 2.2.2.2
    
    ! R1 的配置
    router ospf 1
     area 1 virtual-link 2.2.2.2
    
    ! R2 的配置
    router ospf 1
     area 1 virtual-link 1.1.1.1
    ```
*   **注意事项**：
    *   **应尽量避免使用**。虚链路增加了配置的复杂性，且本身比较脆弱（依赖过境区域的稳定性）。
    *   它应该被视为 **临时的解决方案**，长远之计是重新规划网络以确保骨干区域的连续性。

---

### 3. OSPF 认证 (Authentication)

增强 OSPF 网络的安全性。

*   **是什么？** 通过验证 OSPF 报文的来源，确保只有合法的路由器才能建立邻居关系并交换路由信息。
*   **为什么需要？** 防止恶意用户接入网络，伪装成合法路由器，注入错误的路由信息，从而导致流量被窃取（黑洞攻击）或网络瘫痪。
*   **如何实现？** OSPF 支持多种认证方式：
    *   **Type 0 (Null)**：不认证，默认方式。
    *   **Type 1 (明文认证)**：密码在网络中以明文传输，不安全，基本不用。
    *   **Type 2 (MD5 认证)**：使用 MD5 算法对报文和密钥进行哈希计算，生成摘要。这是当前最常用、最推荐的方式。
    
    **配置示例 (MD5 区域认证):**
    ```cisco
    ! 在同一区域的所有路由器接口上配置
    router ospf 1
     area <area-id> authentication message-digest
    
    interface GigabitEthernet0/0
     ip ospf message-digest-key 1 md5 MySecretPassword
    ```
*   **注意事项**：
    *   同一个网段内的所有路由器必须配置 **完全相同** 的 `key-id` 和 `key`。
    *   认证类型（明文或MD5）也必须一致。

---

### 4. 默认路由分发 (Default Route Distribution)

为 OSPF 域提供一个通往外部网络（如互联网）的出口。

*   **是什么？** 在 OSPF 网络中生成一条默认路由 `0.0.0.0/0`，并通告给其他路由器。
*   **为什么需要？** 让内部路由器在路由表中找不到精确匹配的路由时，能将流量发往指定的出口路由器（通常是连接互联网的 ASBR）。
*   **如何实现？** 主要在 ASBR 上配置。
    ```cisco
    ! 在 ASBR 上配置
    router ospf 1
     default-information originate [always] [metric <value>] [metric-type <1|2>]
    ```
    *   `default-information originate`：命令本身。只有当 ASBR 自己的路由表中存在一条默认路由时，它才会生成 OSPF 默认路由。
    *   `always` (可选，常用)：**无条件**地生成并通告默认路由，即使 ASBR 自己没有默认路由。这在某些冗余设计中很有用。
*   **默认路由的 LSA 类型**：
    *   在标准区域，它作为 **Type 5 LSA** 通告。
    *   在 Stub/Totally Stubby 区域，由 ABR **自动生成 Type 3 LSA** 形式的默认路由。
    *   在 NSSA 区域，可以由 ASBR 生成 **Type 7 LSA**，再由 ABR 转换为 Type 5。

---

### 5. 路径成本调整 (Path Cost Manipulation)

手动干预 OSPF 的选路决策。

*   **是什么？** OSPF 使用 Cost (开销)作为度量值来选择最佳路径，Cost 越小越优。默认 Cost 是根据接口带宽自动计算的。此特性允许管理员手动修改 Cost。
*   **为什么需要？**
    *   **非对称路径**：希望流量走主用链路，而不是低带宽的备用链路。
    *   **流量工程**：引导特定流量走指定的路径。
    *   **修复次优路径**：当默认的 Cost 计算导致选路不符合预期时进行修正。
*   **如何实现？**
    *   **全局修改参考带宽 (影响所有接口)**：默认参考带宽是 100Mbps，对于现代高速网络（>100Mbps）已不适用。建议修改为 10G 或更高。
        ```cisco
        router ospf 1
         auto-cost reference-bandwidth 10000  ! 单位是 Mbits/s, 这里设置为 10Gbps
        ```
    *   **在特定接口上直接修改 Cost**：
        ```cisco
        interface GigabitEthernet0/1
         ip ospf cost 100  ! 手动设置此接口的 OSPF Cost 为 100
        ```
*   **注意事项**：修改 Cost 会直接影响全网的路由计算，必须谨慎操作，确保路径规划的合理性，避免产生路由环路或次优路径。

---

### 6. BFD for OSPF (Bidirectional Forwarding Detection)

为 OSPF 提供毫秒级的快速故障检测。

*   **是什么？** BFD 是一个独立的、轻量级的协议，专门用于快速检测两个邻居之间的连通性。它可以与 OSPF 等路由协议联动。
*   **为什么需要？** OSPF 自身的故障检测依赖 Hello/Dead 定时器，默认 Dead 时间长达 40 秒。对于语音、视频等实时业务，这个中断时间是无法接受的。BFD 可以将检测时间缩短到毫秒级。
*   **如何工作？**
    1.  OSPF 邻居建立后，触发 BFD 建立会话。
    2.  BFD 邻居之间快速地发送 BFD 控制包（默认毫秒级）。
    3.  如果 BFD 在指定时间内没有收到对端的包，就判定链路故障。
    4.  BFD 立即通知 OSPF 进程“邻居已断开”。
    5.  OSPF 无需等待 Dead Timer 超时，立即断开邻居关系并开始重新收敛。
*   **配置示例**：
    ```cisco
    ! 在接口上启用 BFD
    interface GigabitEthernet0/0
     bfd interval 50 min_rx 50 multiplier 3  ! 发送间隔50ms, 接收间隔50ms, 3次不回则判定down
     ip ospf bfd
    ```

---

### 7. Graceful Restart / NSF (Non-Stop Forwarding)

实现控制平面重启时的数据平面不中断，也称为“优雅重启”。

*   **是什么？** 一种高可用性技术。当路由器的 OSPF 进程（控制平面）需要重启（如升级、崩溃）时，其数据平面（CEF 转发表）保持不变，继续转发流量，避免了网络中断。
*   **为什么需要？** 在核心网络中，路由器的任何中断都会造成巨大影响。GR/NSF 确保了在计划内维护或意外的软件故障时，网络流量几乎不受影响，从而大大提高了网络的可靠性。
*   **如何工作？**
    *   **重启路由器**：在重启前，通知其邻居“我要重启了，请帮我维持一下邻居关系和路由”。
    *   **邻居路由器 (Helper)**：收到通知后，进入“Helper 模式”，在一段时间内（Grace Period）假定该邻居仍然可达，并继续通告与它相关的路由。
    *   **重启完成**：重启路由器完成后，重新与邻居建立 OSPF 关系，并从邻居那里同步最新的 LSDB，然后通知邻居“我回来了”。整个过程对网络中的其他路由器是透明的。
*   **配置示例**：
    ```cisco
    ! 在需要支持 GR 的路由器上配置
    router ospf 1
     nsf  ! (在思科设备上，这个命令通常就够了，会启用默认的 GR 功能)
    ```
*   **注意事项**：GR/NSF 需要邻居双方都支持该功能才能生效。


## 8.9 OSPF 基础配置命令

1. 创建并运行 OSPF 进程
	~~~shell
	[Huawei]ospf [ process-id | router-id id]
	~~~
	- porcess-id用于标识osPF进程默认进程号为1,OSPF支持多进程，在同一台设备上可以运行多个不同的OSPF进程，它们之间互不影响，彼此独立
	- router-id用于手工指定设备的ID号。如果没有通过命令指定ID号，系统会从当前接口的IP地址中自动选取一个作为设备的ID号。
2. 创建并进入 OSPF 区域
	~~~shell
	[Huawei-ospf-1]area area-id
	~~~~
	- area命令用来创建OSPF区域，并进入OSPF区域视图。
	- area-id可以是十进制整数或点分十进制格式。采取整数形式时，取值范围是0～4294967295。
3. 指定运行 OSPF 的接口
	~~~shell
	[Huawei-ospf-1-area-0.0.0.0]network network-address wildcard-mask
	~~~
	- network命令用来指定运行osPF协议的接口和接口所属的区域。。network-address为接口所在的网段地址。
	- wildcard-mask 为 ip 地址的反码，相当于将IP地址的掩码反转（0变1，1变0），例如0.0.0.255表示掩码长度24bit。
4. (接口视图)配置OSPF接口开销
	~~~shell
	[Huawei-GigabitEthernet0/0/0]ospf cost cost
	~~~
	- ospf cost命令用来配置接口上运行OSPF协议所需的开销。缺省情况下，OSPF会根据该接口的带宽自动计算其开销值 cost 取值范围是1～65535。
5. (OSPF视图)设置OSPF带宽参考值
	~~~shell
	[Huawei-ospf-1]bandwidth-reference value
	~~~
	- bandwidth-reference命令用来设置通过公式计算接口开销所依据的带宽参考值。value取值范围是1～2147483648，单位是Mbit/s，缺省值是100Mbit/s，缺省值现在的参考意思不多，因为我们的宽带都大了。
6. (接口视图)设置接口在选举DR时的优先级
	~~~shell
	[Huawei-GigabitEthernet0/0/0]ospf dr-priority priority
	~~~
	- ospfdr-priority命令用来设置接口在选举DR时的优先级。priority值越大，优先级越高，取值范围是0～255。

# 九、以太网交换技术

在网络中传输数据时需要遵循一些标准，以太网协议定义了数据帧在以太网上的传输标准，了解以太网协议是充分理解数据链路层通信的基础。以太网交换机是实现数据链路层通信的主要设备，了解以太网交换机的工作原理也是十分必要的。

## 9.1 以太网协议

以太网是当今现有局域网 （Local Area Network,LAN）采用的最通用的通信协议标准，该标准定义了在局域网中采用的电缆类型和信号处理方法。

以太网是建立在CSMA/CD (Carrier Sense Multiple Access/Collision Detection， 载波监听多路访问/冲突检测)机制上的广播型网络。


## 9.2 冲突域和广播域

| 特性        | 冲突域 (Collision Domain)         | 广播域 (Broadcast Domain)         |
| --------- | ------------------------------ | ------------------------------ |
| **OSI层次** | 物理层 (Layer 1)                  | 数据链路层 (Layer 2)                |
| **问题**    | 数据“碰撞”，导致传输失败和重传               | 无用的“广播”信息泛滥，消耗网络和CPU资源         |
| **比喻**    | 一条单行道，一次只能过一辆车                 | 一个大喇叭喊话，整个区域都能听到               |
| **隔离设备**  | **交换机 (Switch)** / 网桥 (Bridge) | **路由器 (Router)** / 三层交换机(VLAN) |

**一句话总结：交换机用来分割冲突域，路由器用来分割广播域。**


冲突域指的是一个网络区域，在这个区域里，如果两台或更多设备 **同时发送数据**，它们的信号就会在物理介质（如网线）上发生“碰撞”，导致数据损坏，谁也发不成功。

它是一个 **物理层** 的概念。

广播域指的是一个网络区域，在这个区域里，任何一台设备发送一个 **广播**（目标MAC地址为 `FF:FF:FF:FF:FF:FF` 的帧），这个广播帧会被传输到该区域内的 **所有其他设备**。

它是一个 **数据链路层** 的概念。

## 9.3 以太网卡

网络接口卡(Network Interface Card,NIC)也称为“网卡”，是计算机、交换机、路由器等网络设备与外部网络世界相连的关键部件。

## 9.4 以太网帧格式

- 以太网技术所使用的帧称为以太网帧(Ethernet Frame)，或简称以太帧.
- 以太帧的格式有两个标准：Ethernet_II格式和IEEE 802.3格式。
![[Pasted image 20250809230147.png]]
## 9.5 MAC地址

MAC (Media Access Control)地址在网络中唯一标识一个网卡，每个网卡都需要并拥有唯一的一个MAC地址。
- 一块网卡的MAC地址是具有全球唯一性的。

> 每个以太网设备在出厂时都有一个唯一的MAC地址，但在设备接入网络时，会同时为每台主机再分配一个IP地址，这个原因是什么？
> IP地址的特点:
> - IP地址是唯一的
> - IP地址可变
> - 基于网络拓扑进行IP地址分配
> MAC地址的特点:
> - MAC地址是唯一的
> - MAC地址不可变
> - 基于制造商进行MAC地址分配

MAC 地址表示：

- 一个MAc地址有48 bit，6 Byte。
- MAC地址通常采用“十六进制"+ ""表示。
![[Pasted image 20250809231740.png]]


MAC地址构成及分类：

- OUI (Organizationally Unique Identifier） :厂商代码,由lEEE分配,3 Byte, 24 bit。
- 制造商分配：3 Byte，24 bit 

MAC地址表：

每台交换机中都有一个MAC地址表，存放了MAC地址与交换机端口编号之间的映射关系。

## 9.6 单播以太帧和广播以太帧

![[Pasted image 20250809232923.png]]
![[Pasted image 20250809235648.png]]


## 9.7 交换机的3种数据帧处理行为

交换机对于从传输介质进入某一端口的帧的处理行为一共有3种：
![[Pasted image 20250810002552.png]]




